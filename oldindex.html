<html>
<head>
    <title>Jeapardy Helper | Add Users and Buzz</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <link rel="stylesheet" href="/app.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light">
        <div class="container">
            <span class="navbar-brand wide">
                <span class="title">Jeapardy Helper</span>
            </span>
        </div>
    </nav>

    <div id="example-1">
        <div class="container" style="margin-top: 50px">
            <a href="#" class="btn btn-primary btn-sm" id="add-team-btn" v-on:click="createTeamAndRedirect()">Add a team</a>
            <a href="#" class="btn btn-primary btn-sm" id="clear-teams-btn" v-on:click="deleteTeams()">Clear Teams</a>
            <a href="#" class="btn btn-primary btn-sm" id="clear-teams-btn" v-on:click="clearClickedTime()">Clear Buzzer Times</a>
            <hr>
            <ul>
                <ul v-for="item in tloaded">
                    <div class="card">
                        <a href="#" class="btn" v-on:click="setSelectedTeam(item)">
                            <div class="card-body">
                                {{ item }}
                            </div>
                        </a>
                    </div>
                </ul>
            </ul>
        </div>

        <div class="container" style="margin-top: 50px">
            <h2>Selected Team:</h2>
            <h1>{{ selectedTeam }} </h1>
        </div>

        <div class="container" style="margin-top: 50px" v-if="selectedTeam != 'No team has been selected'">
            <a href="#" class="btn btn-danger btn-sm" id="add-team-btn" v-on:click="updateClickedTime(selectedTeam)">Buzzer</a>
            <h2>Buzzed Teams:</h2>
            <ul>
                <ul v-for="team in orderedBuzzClicks">
                    <div class="card">
                        <div class="card-body">
                            {{ team.name }}
                        </div>
                    </div>
                </ul>
            </ul>
        </div>
    </div>
    <!-- development version, includes helpful console warnings -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="//cdn.jsdelivr.net/combine/npm/jquery@3.2.1,npm/axios@0.17.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
    <!-- <script src="/app.js"></script> -->

    <script>
        var vm = new Vue({
            el: '#example-1',
            data: {
                message: 'Hello',
                tloaded: [],
                selectedTeam: 'No team has been selected',
                buzzedTeams: []
            },
            computed: {
                orderedBuzzClicks: function () {
                    return _.orderBy(this.buzzedTeams, 'clickedTime')
                }
            },
            watch: {
                tloaded: function (){
                    this.reloadTeams()
                },
                selectedTeam: function (){},
                buzzedTeams: function (){
                }
            },
            created() {
                /**
                 * Load the teams to the page...
                 */
                var loadedTeamsArray = []
                axios.get('/teams')
                .then(response => {
                const teams = response.data
                        for (const key in teams) {
                            if (teams.hasOwnProperty(key)) {
                                loadedTeamsArray.push(teams[key].name)
                            }
                        }
                        this.tloaded = loadedTeamsArray
                    })
                .catch(e => {
                this.errors.push(e)
                })
            },
            methods: {
                createTeamAndRedirect: function(evt) {
                    var teamName = prompt("Please enter your team name with no spaces!")
                    if(teamName != null){
                    teamName = teamName.replace(' ','')
                        axios.post('/teams/' + teamName)
                        .then(response => console.log(response.data))
                    }
                },
                reloadTeams: async function(){
                    var loadedTeamsArray = []
                    let result = await axios.get('/teams').then(response => {
                        const teams = response.data
                        for (const key in teams) {
                            if (teams.hasOwnProperty(key)) {
                                loadedTeamsArray.push(teams[key].name)
                            }
                        }
                    })
                    this.tloaded = loadedTeamsArray
                },
                setSelectedTeam: function (teamName){
                    this.selectedTeam = teamName
                    console.log("Selected Team: " + this.selectedTeam)
                },
                deleteTeams: async function(evt) {
                    this.selectedTeam = 'No team has been selected' 
                    this.buzzedTeams = []                    
                    let result = await axios.delete('/teams/delete')
                    .then(response => {
                        console.log(response.data);
                    })                   
                },
                updateClickedTime: async function(teamName) {
                    console.log(teamName + " buzzed")
                    let result = await axios.put('/teams/' + teamName + '/clickedBuzzer')
                    .then(response => {
                        console.log(response.data);
                        this.fetchBuzzedList()
                    })  
                },
                clearClickedTime: async function(){
                    let result = await axios.put('/teams/clearClickedTime')
                    .then(response => {
                        console.log(response.data);
                        this.buzzedTeams = []
                    })  
                },
                fetchBuzzedList: async function(){
                    this.buzzedTeams = []
                    let result = await axios.get('/teams').then(response => {
                        const teams = response.data
                        for (const key in teams) {
                            if (teams.hasOwnProperty(key)) {
                                if(teams[key].clickedTime != ''){
                                    this.buzzedTeams.push(teams[key])
                                }                              
                            }
                        }
                    })
                    console.log(this.buzzedTeams)
                }                 
            }
        })
    </script>

</body>
</html>

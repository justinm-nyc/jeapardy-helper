<html>
<head>
    <title>Jeopardy Helper | Add Users and Buzz</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light">
        <div class="container">
            <span class="navbar-brand wide">
                <span class="title">Jeopardy Helper</span>
            </span>
        </div>
    </nav>

    <div id="example-1">

        <div class="container">
            <div class="row">
                <div class="col-md-6 teams-side">                  
                    <a href="#" class="btn btn-primary btn-sm add-team-button" id="add-team-btn" v-on:click="createTeamAndRedirect()">Add a team</a>
                    <a href="#" class="btn btn-primary btn-sm clear-teams-button" id="clear-teams-btn" v-on:click="deleteTeams()">Clear Teams</a>
                    <a href="#" class="btn btn-primary btn-sm clear-buzzer-times-button" id="clear-teams-btn" v-on:click="clearClickedTime()">Clear Buzzer Times</a>
                    <hr>

                    <div class="col-md-4">
                        <h2> TEAMS: </h2>
                        <ul v-for="item in tloaded">
                            <a href="#" class="" v-on:click="setSelectedTeam(item)">
                                <div class="media">
                                    <img src="https://image.flaticon.com/icons/png/128/27/27825.png" height="22" width="22" class="mr-3" alt="...">
                                    <div class="media-body">
                                        <h5 class="mt-0">{{ item }}</h5>
                                    </div>
                                </div>
                            </a>
                        </ul>
                    </div>
                </div>


                <div class="col-md-6 buzzer-side">      
                    <h2>SELECTED TEAM:</h2>
                    <h1>{{ selectedTeam }} </h1>
   
                    <div class="container" style="margin-top: 50px" v-if="selectedTeam != 'No team has been selected'">
                        <a href="#" class="btn btn-danger btn-lg" id="add-team-btn" v-on:click="updateClickedTime(selectedTeam)">Buzzer</a>
                        <h2>Buzzed Teams:</h2>
                        <table class="table">
                            
                            <ul v-for="(team, index) in orderedBuzzClicks">
                                  {{ index+1 }}. {{ team.name }}
                            </ul>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- development version, includes helpful console warnings -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="//cdn.jsdelivr.net/combine/npm/jquery@3.2.1,npm/axios@0.17.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
    <!-- <script src="/app.js"></script> -->

    <script>
        var vm = new Vue({
            el: '#example-1',
            data: {
                message: 'Hello',
                tloaded: [],
                selectedTeam: 'No team has been selected',
                buzzedTeams: []
            },
            computed: {
                orderedBuzzClicks: function () {
                    return _.orderBy(this.buzzedTeams, 'clickedTime')
                }
            },
            watch: {
                tloaded: function (){
                    this.reloadTeams()
                },
                selectedTeam: function (){},
                buzzedTeams: function (){}
            },
            created() {
                /**
                 * Load the teams to the page...
                 */
                var loadedTeamsArray = []
                axios.get('/teams')
                .then(response => {
                const teams = response.data
                        for (const key in teams) {
                            if (teams.hasOwnProperty(key)) {
                                loadedTeamsArray.push(teams[key].name)
                            }
                        }
                        this.tloaded = loadedTeamsArray
                    })
                .catch(e => {
                this.errors.push(e)
                })
            },
            methods: {
                createTeamAndRedirect: function(evt) {
                    var teamName = prompt("Please enter your team name with no spaces!")
                    if(teamName != null){
                    teamName = teamName.replace(' ','')
                        axios.post('/teams/' + teamName)
                        .then(response => console.log(response.data))
                    }
                },
                reloadTeams: async function(){
                    var loadedTeamsArray = []
                    var loadedBuzzedTeamsArray = []
                    let result = await axios.get('/teams').then(response => {
                        const teams = response.data
                        for (const key in teams) {
                            if (teams.hasOwnProperty(key)) {
                                loadedTeamsArray.push(teams[key].name)
                                if(teams[key].clickedTime != ''){
                                    loadedBuzzedTeamsArray.push(teams[key])
                                }  
                            }
                        }
                    })
                    this.tloaded = loadedTeamsArray
                    this.buzzedTeams = loadedBuzzedTeamsArray

                    if(this.tloaded.length == 0){
                        this.setSelectedTeam('No team has been selected' )
                    }
                },
                setSelectedTeam: function (teamName){
                    this.selectedTeam = teamName
                    console.log("Selected Team: " + this.selectedTeam)
                },
                deleteTeams: async function(evt) {
                    this.selectedTeam = 'No team has been selected' 
                    this.buzzedTeams = []                    
                    let result = await axios.delete('/teams/delete')
                    .then(response => {
                        console.log(response.data);
                    })                   
                },
                updateClickedTime: async function(teamName) {
                    console.log(teamName + " buzzed")
                    let result = await axios.put('/teams/' + teamName + '/clickedBuzzer')
                    .then(response => {
                        console.log(response.data);
                    })  
                },
                clearClickedTime: async function(){
                    let result = await axios.put('/teams/clearClickedTime')
                    .then(response => {
                        console.log(response.data);
                        this.buzzedTeams = []
                    })  
                }             
            }
        })
    </script>

</body>
</html>
